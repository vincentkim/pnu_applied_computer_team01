
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/admin.css" />
    <title>Admin Page</title>
  </head>
  <body>
    <script type="text/javascript">

    //뒤로 가기로 못 오게 막음(임시)-사파리에서 가능
        /*function noBack(){window.history.forward();}
        noBack();
        window.onload=noBack;
        window.onpageshow=function(evt){if(evt.persisted)noBack();}
        window.onunload=function(){void(0);}*/
        window.onpageshow = function(event){
            var agent = navigator.userAgent.toLowerCase();
            if(event.persisted || (window.performance&&window.performance.navigation.type==2)){
                window.location.reload();
            }else{}
        }

        function rowAdd(){
            var userTableRow=document.getElementById("userTable").insertRow();
            //id
            var cell_id=userTableRow.insertCell();
            cell_id.innerHTML="<input type='text' id='cellId'/>";
            //email
            var cell_email=userTableRow.insertCell();
            cell_email.innerHTML="<input type='email' id='cellEmail'/>";
            //name
            var cell_name=userTableRow.insertCell();
            cell_name.innerHTML="<input type='text' id='cellName'/>";
            //추가
            var cell_add=userTableRow.insertCell();
            cell_add.innerHTML="<input type='button' value='추가' id='addUser' onclick='addUser(this)'/>";
        }
        function addUser(object){
            if(!confirm("새로운 사용자의 패스워드는 1234로 저장됩니다. 추가하시겠습니까?")) return;
            var user_row=object.parentNode.parentNode;
            var user_info=user_row.childNodes;
            const arduino_id=user_info[0].firstChild.value;
            const user_email=user_info[1].firstChild.value;
            const user_name=user_info[2].firstChild.value;
            if(checkAdd(arduino_id,user_email,user_name)){
                addUserToDB(arduino_id,user_email,user_name);
            }
        }
        function checkAdd(id,email,name){
            if(id==""||email==""||name==""){
                alert("모든 값을 입력하시오.")
                return false;
            }
            var unregisteredArduino = <%- JSON.stringify(unregisteredArduino)%>; //등록되지 않은 아두이노에 속해야 한다
            for(let i=0;i<unregisteredArduino.length;i++){
                if(id==unregisteredArduino[i].id) break;
                if(i==unregisteredArduino.length-1){
                    alert("이미 등록되거나 존재하지 않은 아두이노입니다.")
                    return false;
                } 
            }
            var userData=<%- JSON.stringify(userData)%>;
            //이미 가입된 이메일인데 이메일과 이름이 다르면 안 됨
            for(let i=0;i<userData;i++){
                if(email==userData[i].email){
                    if(name!=userData[i].name){
                        alert("이미 가입된 사용자와 이름이 일치하지 않습니다.");
                        return false;
                    }else return true;
                }
            }
            return true;
        }
        function addUserToDB(id,email,name){
            var user_id=email.replaceAll("@","%40");
            location.href="/admin/register?arduino_id="+id+"&user_id="+user_id+"&user_name="+name;
        }

        function deleteUser(object){
            var user_row=object.parentNode.parentNode;
            var arduino_id=user_row.cells[0].innerHTML.trim();
            var user_id=user_row.cells[1].innerHTML.trim();
            var user_body=user_row.parentNode;
            if(confirm("정말로 삭제하시겠습니까?")){
                deregisterArduinoFromUser(user_id,arduino_id);
            }
        }
        function deregisterArduinoFromUser(user_id,arduino_id){
            var user_id=user_id.replaceAll("@","%40");
            location.href="/admin/deregister?user_id="+user_id+"&arduino_id="+arduino_id;
        }
        function goToDetails(object){
            var data_row=object.parentNode.parentNode;
            const arduino_id=data_row.cells[0].innerHTML.trim();
            location.href="/admin/details?id="+arduino_id;
        }
    </script>

    
    <div class="header">
      <h1 class="page_header">Admin Page</h1> 
        <div style="font-size: 20px;">Welcome,<%=name%> 
        <p class="logout"><a href="/admin/logout">Logout</a> <span class="fontawesome-remove-sign"></span></p>
        </div>
    </div>
    <hr>
    
    <div>
        
        <table border="5", class="connect">
            <tr>
                <td class="table_title" colspan="4"><strong>Arduino - User Connection</strong></td>
            </tr>
            <colgroup>
                <col class="arduino"/>
                <col class="email"/>
                <col class="name"/>
                <col class="add_button"/>
            </colgroup>
            
           <th class="table_head" >Arduino</th>
           <th class="table_head" >Email</th>
           <th class="table_head" >Name</th>
           <th class="table_head" ><input type="button" value="+" onclick="rowAdd()"></th>
           <tbody id="userTable" class="table_body">
           <%for(let i=0;i<userData.length;i++){%>
           <tr class="table_row">
               <td class="table_data">
                    <%=userData[i].arduino%>
               </td>
               <td class="table_data">
                    <%=userData[i].email%>
               </td>
               <td class="table_data">
                    <%=userData[i].name%>
               </td>
               <td class="table_data">
                   <input type="button" value="Delete" onclick="deleteUser(this)">
               </td>
           </tr>
           <%}%> 
            </tbody>
        </table>
    </div>
    <hr width="1500px">
    <div>
        <table border="5", class="state">
            <tr>
                <td class="table_title" colspan="7"><strong>Arduino Data</strong></td>
            </tr>
            <colgroup>
                <col class="arduino_id"/>
                <col class="humidity"/>
                <col class="temp"/>
                <col class="renewal_time"/>
                <col class="on_off"/>
                <col class="current_state"/>
                <col class="details"/>
            </colgroup>
           <th class="table_head" >Arduino Id</th>
           <th class="table_head" >Humidity</th>
           <th class="table_head" >Temperature</th>
           <th class="table_head" >Renewal time</th>
           <th class="table_head" >ON/OFF</th>
           <th class="table_head" >Current state</th>
           <th class="table_head" >Details</th>
           <tbody class="table_body">
            <%for(let i=0;i<stateData.length;i++){%>
           <tr class="table_row">
               <td class="table_data">
                   <%=stateData[i].id%>
               </td>
               <td class="table_data">
                   <%=stateData[i].humidity%>
               </td>
               <td class="table_data">
                    <%=stateData[i].temp%>
               </td>

               <td class="table_data">
                    <%=stateData[i].createdat%>
               </td>
               <td class="table_data">
                <% 
                    var renewal_time=Date.parse(stateData[i].createdat);
                    var now = new Date();
                    var gap=now.getTime()-renewal_time;
                    var sec_gap=gap/1000;
                    var isOff=(sec_gap>=30);
                    if(isOff){
                %>
                        Off
                <%
                    }else{
                %>
                    On        
                <%
                    }
                %>
               </td>
               <td class="table_data">
                    <span class="state_dot" style="background-color:
                        <%
                            if(isOff){
                        %>
                            black" title="정지"
                        <%
                            }else if(stateData[i].temp>=60){
                        %>
                            red" title="위험"
                        <%
                            }else if(stateData[i].temp>=40){
                        %>
                            yellow" title="경고"
                        <%
                            }else{
                        %>
                            green" title="정상"
                        <%
                            }
                        %>
                            >
                    </span>
               </td>
               <td class="table_data">
                    <span class="details" onclick="goToDetails(this)" style="cursor:pointer" >details</span>
                </td>
           </tr>
           <%}%>
            </tbody>    
        </table>
    </div>
  </body>
</html>


